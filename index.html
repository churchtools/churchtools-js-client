<!DOCTYPE html>
<html lang="de">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Beispiel Benutzung</title>
    </head>

    <body>
        <form>
            ChurchTools URL: <br />
            <input id="url" type="text" value="https://testdavid.church.tools" name="url" /> <br />
            <div id="api-requests"></div>
            <input id="username" type="text" name="username" /> <br />Passwort <br />
            <input id="password" type="password" name="password" /> <button id="login">login</button>
            <button id="logout">logout</button> <button id="clear">clear</button>
        </form>
        <h1>Ausgabe</h1>
        <div id="content"></div>
        <h1>Fehler</h1>
        <div id="error"></div>

        <script
            src="https://code.jquery.com/jquery-3.3.1.min.js"
            integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
            crossorigin="anonymous"
        ></script>
        <script src="dist/churchtools-client.js"></script>
        <script>
            const client = churchtoolsClient.churchtoolsClient;
            const api = churchtoolsClient.churchtoolsApi;
            client.enableCrossOriginRequests();
            churchtoolsClient.activateLogging();
            client.onUnauthenticated(() => {
                alert('unauthorized');
            });

            const apiRequests = {
                whoami: () => {
                    return api.whoami();
                },
                masterdata: () => {
                    return api.masterdata('churchdb');
                },
                validchurchtoolsurl: () => {
                    const url = document.getElementById('url').value;
                    return client.validChurchToolsUrl(url);
                },
                person: () => {
                    return api.person(1);
                },
                services: () => {
                    return api.services();
                },
                serviceGroups: () => {
                    return api.serviceGroups();
                },
                personEvents: () => {
                    return api.personEvents(1);
                },
                acceptServiceRequest: () => {
                    return api.acceptServiceRequest(1, 1, 1);
                },
                declineServiceRequest: () => {
                    return api.declineServiceRequest(1, 1, 1);
                },
                personSearch: () => {
                    return api.searchPersons('david');
                },
                logintoken: () => {
                    return api.logintoken(1);
                },
                members: () => {
                    return api.members(1);
                },
                personsAll: () => {
                    return api.personsAll([1, 2, 3, 4, 5]);
                },
                groupsAll: () => {
                    return api.groupsAll();
                },
                groupsForPerson: () => {
                    return api.groupsForPerson(1, true, true);
                },
                getFilteredGroups: () => {
                    return api.getFilteredGroups({campusIds: [1, null], isOpenForMembers: true, ageGroupIds: [1, null]});
                },
                getGroupSignUpLink: () => {
                    return api.getGroupSignUpLink(16, 1);
                },
                getFileMetadata: () => {
                    return api.getFileMetadata(517);
                },
                deleteAvatar: () => {
                    return api.deleteAvatar(57);
                },
                getEvent: () => {
                    return api.getEvent(24);
                },
                getAllEvents: () => {
                    return api.getAllEvents();
                },
                getPublicGroupInfo: () => {
                    return api.getPublicGroupInfo(59);
                },
                getPermissionsGlobal: () => {
                    return api.getPermissionsGlobal();
                },
                getPermissionsForPerson: () => {
                    return api.getPermissionsForPerson(1);
                },
                invitePerson: () => {
                    return api.invitePerson(1);
                },
                getPersonProperties: () => {
                    return api.getPersonProperties(1, 7, 16)
                }
            };

            Object.keys(apiRequests).forEach(apiRequestKey => {
                const apiRequestsDiv = document.getElementById('api-requests');
                const button = document.createElement('button');
                button.id = apiRequestKey;
                button.innerHTML = apiRequestKey;
                apiRequestsDiv.appendChild(button);

                button.addEventListener('click', e => {
                    setUrl();
                    e.preventDefault();
                    apiRequests[apiRequestKey]()
                        .then(content => {
                            addContent(content);
                        })
                        .catch(error => {
                            addError(error);
                        });
                });
            });

            document.getElementById('login').addEventListener('click', e => {
                e.preventDefault();
                setUrl();
                const user = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                api.login(user, password)
                    .then(login => {
                        addContent(login);
                        api.whoami()
                            .then(user => {
                                addContent(user);
                                api.logintoken(user.id)
                                    .then(logintoken => {
                                        addContent(logintoken);
                                        client.setUnauthorizedInterceptor(logintoken, user.id);
                                    })
                                    .catch(addError);
                            })
                            .catch(addError);
                    })
                    .catch(error => {
                        addError(error);
                    });
            });
            document.getElementById('logout').addEventListener('click', e => {
                e.preventDefault();
                api.logout();
            });
            $('#clear').click(e => {
                e.preventDefault();
                $('#content').html('');
                $('#error').html('');
            });

            function setUrl() {
                const urlInput = document.getElementById('url');
                const url = urlInput.value;
                client.setBaseUrl(url);
            }

            function addContent(object) {
                console.log(object);
                $('#content').append('<div>' + JSON.stringify(object) + '</div>');
            }

            function addError(object) {
                console.log(object);
                $('#error').append('<div>' + JSON.stringify(object) + '</div>');
            }
        </script>
    </body>
</html>
